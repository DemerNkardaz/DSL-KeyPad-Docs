/* @license
 * Copyright (c) 2019-2024, lengyanyu258 <lengyanyu258@outlook.com>
 * Released under the BSD-2-Clause license
 * https://github.com/lengyanyu258/xiangqi.js/blob/master/LICENSE
 */
"use strict";const Xiangqi=function(e){const n="b",t="r",r=-1,i="p",o="c",s="r",u="n",l="b",f="a",c="k",a="pcrnbakPCRNBAK",p="rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR r - - 0 1",h=Object.freeze(["1-0","0-1","1/2-1/2","*"]),d=Object.freeze({b:[16,-1,1],r:[-16,-1,1]}),g=Object.freeze({c:[-16,16,-1,1],r:[-16,16,-1,1],n:[-33,-31,31,33,-18,14,-14,18],b:[-34,34,30,-30],a:[-17,17,15,-15],k:[-16,16,-1,1]}),b=Object.freeze({NORMAL:"n",CAPTURE:"c"}),m=Object.freeze({NORMAL:1,CAPTURE:2}),y=Object.freeze({a9:0,b9:1,c9:2,d9:3,e9:4,f9:5,g9:6,h9:7,i9:8,a8:16,b8:17,c8:18,d8:19,e8:20,f8:21,g8:22,h8:23,i8:24,a7:32,b7:33,c7:34,d7:35,e7:36,f7:37,g7:38,h7:39,i7:40,a6:48,b6:49,c6:50,d6:51,e6:52,f6:53,g6:54,h6:55,i6:56,a5:64,b5:65,c5:66,d5:67,e5:68,f5:69,g5:70,h5:71,i5:72,a4:80,b4:81,c4:82,d4:83,e4:84,f4:85,g4:86,h4:87,i4:88,a3:96,b3:97,c3:98,d3:99,e3:100,f3:101,g3:102,h3:103,i3:104,a2:112,b2:113,c2:114,d2:115,e2:116,f2:117,g2:118,h2:119,i2:120,a1:128,b1:129,c1:130,d1:131,e1:132,f1:133,g1:134,h1:135,i1:136,a0:144,b0:145,c0:146,d0:147,e0:148,f0:149,g0:150,h0:151,i0:152});let v=new Array(256),q={r:r,b:r},w=t,A=0,N=1,k=[],R=[],_={};function O(e){void 0===e&&(e=!1),v=new Array(256),q={r:r,b:r},w=t,A=0,N=1,k=[],R=[],e||(_={}),$(j())}function C(){P(p)}function P(e,r){if(void 0===r&&(r=!1),!E(e).valid)return!1;let i,o,s=e.split(/\s+/),u=s[0],l=0;O(r);for(let e=0;e<u.length;++e)i=u.charAt(e),"/"===i?l+=7:-1!=="0123456789".indexOf(i)?l+=parseInt(i,10):(o=i<"a"?t:n,L({type:i.toLowerCase(),color:o},Y(l)),l++);return w=s[1]===n?n:t,A=parseInt(s[4],10),N=parseInt(s[5],10),$(j()),!0}function E(e){const r={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) should be '-'.",5:"3rd field (castling availability) should be '-'.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 10 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"1st field (piece positions) is invalid [each side has one king].",12:"1st field (piece positions) is invalid [each side has no more than 2 advisers].",13:"1st field (piece positions) is invalid [each side has no more than 2 bishops].",14:"1st field (piece positions) is invalid [each side has no more than 2 knights].",15:"1st field (piece positions) is invalid [each side has no more than 2 rooks].",16:"1st field (piece positions) is invalid [each side has no more than 2 cannons].",17:"1st field (piece positions) is invalid [each side has no more than 5 pawns].",18:"1st field (piece positions) is invalid [black king should at right position].",19:"1st field (piece positions) is invalid [red king should at right position].",20:"1st field (piece positions) is invalid [black adviser should at right position].",21:"1st field (piece positions) is invalid [red adviser should at right position].",22:"1st field (piece positions) is invalid [black bishop should at right position].",23:"1st field (piece positions) is invalid [red bishop should at right position].",24:"1st field (piece positions) is invalid [black pawn should at right position].",25:"1st field (piece positions) is invalid [red pawn should at right position]."};function o(e){return{valid:0===e,error_number:e,error:r[e]}}const s=e.split(/\s+/);if(6!==s.length)return o(1);if(isNaN(s[5])||parseInt(s[5],10)<=0)return o(2);if(isNaN(s[4])||parseInt(s[4],10)<0)return o(3);if(!/^-$/.test(s[3]))return o(4);if(!/^-$/.test(s[2]))return o(5);if(!/^([rwb])$/.test(s[1]))return o(6);const u=s[0].split("/");if(10!==u.length)return o(7);const a={p:{number:0,squares:[]},P:{number:0,squares:[]},c:{number:0,squares:[]},C:{number:0,squares:[]},r:{number:0,squares:[]},R:{number:0,squares:[]},n:{number:0,squares:[]},N:{number:0,squares:[]},b:{number:0,squares:[]},B:{number:0,squares:[]},a:{number:0,squares:[]},A:{number:0,squares:[]},k:{number:0,squares:[]},K:{number:0,squares:[]}};let p,h,d,g;for(p=0;p<u.length;p++){for(d=0,g=!1,h=0;h<u[p].length;h++)if(isNaN(u[p][h])){try{++a[u[p][h]].number}catch(e){return o(9)}a[u[p][h]].squares.push(p<<4|d),d+=1,g=!1}else{if(g)return o(8);d+=parseInt(u[p][h],10),g=!0}if(9!==d)return o(10)}if(1!==a.k.number||1!==a.K.number)return o(11);if(a.a.number>2||a.A.number>2)return o(12);if(a.b.number>2||a.B.number>2)return o(13);if(a.n.number>2||a.N.number>2)return o(14);if(a.r.number>2||a.R.number>2)return o(15);if(a.c.number>2||a.C.number>2)return o(16);if(a.p.number>5||a.P.number>5)return o(17);if(re(c,a.k.squares[0],n))return o(18);if(re(c,a.K.squares[0],t))return o(19);for(p=0;p<a.a.squares.length;++p)if(re(f,a.a.squares[p],n))return o(20);for(p=0;p<a.A.squares.length;++p)if(re(f,a.A.squares[p],t))return o(21);for(p=0;p<a.b.squares.length;++p)if(re(l,a.b.squares[p],n))return o(22);for(p=0;p<a.B.squares.length;++p)if(re(l,a.B.squares[p],t))return o(23);for(p=0;p<a.p.squares.length;++p)if(re(i,a.p.squares[p],n))return o(24);for(p=0;p<a.P.squares.length;++p)if(re(i,a.P.squares[p],t))return o(25);return o(0)}function j(){let e,n,r=0,i="";for(let o=y.a9;o<=y.i0;++o)null==v[o]?r++:(r>0&&(i+=r,r=0),e=v[o].color,n=v[o].type,i+=e===t?n.toUpperCase():n.toLowerCase()),J(o)>=8&&(r>0&&(i+=r),o!==y.i0&&(i+="/"),r=0,o+=7);return[i,w,"-","-",A,N].join(" ")}function x(e){for(let n=0;n<e.length;n+=2)"string"==typeof e[n]&&"string"==typeof e[n+1]&&(_[e[n]]=e[n+1]);return _}function $(e){k.length>0||(e!==p?_.FEN=e:delete _.FEN)}function I(e){const n=v[y[e]];return n?{type:n.type,color:n.color}:null}function L(e,n){if(!("type"in e)||!("color"in e))return!1;if(-1===a.indexOf(e.type.toLowerCase()))return!1;if(!(n in y))return!1;const t=y[n];return(e.type!==c||q[e.color]===r||q[e.color]===t)&&(!re(e.type,t,e.color)&&(v[t]={type:e.type,color:e.color},e.type===c&&(q[e.color]=t),$(j()),!0))}function U(e){function n(e,n,t,r,i){n.push(function(e,n,t,r){let i={color:w,from:n,to:t,flags:r,piece:e[n].type};return e[t]&&(i.captured=e[t].type),i}(e,t,r,i))}let t=[],r=w,a=ee(r),p=y.a9,h=y.i0;const b=void 0===e||!("legal"in e)||e.legal,q=void 0!==e&&"opponent"in e&&e.opponent;if(void 0!==e&&"square"in e){if(!(e.square in y))return[];p=h=y[e.square]}let A,N,k,R,_,O,C,P;for(q&&(w=ee(w),r=w,a=ee(r)),A=p;A<=h;++A)if(R=v[A],null!=R&&R.color===r){for(_=R.type===i?d[r]:g[R.type],N=0,k=_.length;N<k&&(!(R.type===i&&N>0)||ne(A,r));++N)for(O=_[N],C=A,P=!1;!(C+=O,te(C)||R.type===u&&ie(A,N)||R.type===l&&(oe(A,N)||ne(C,r))||(R.type===f||R.type===c)&&re(R.type,C,r));){if(null==v[C]){if(R.type===o&&P)continue;n(v,t,A,C,m.NORMAL)}else{if(R.type!==o){v[C].color===a&&n(v,t,A,C,m.CAPTURE);break}if(P){v[C].color===a&&n(v,t,A,C,m.CAPTURE);break}P=!0}if(R.type!==o&&R.type!==s)break}J(A)>=8&&(A+=7)}if(!b)return t;let E=[];for(A=0,k=t.length;A<k;A++)Z(t[A]),z(r)||E.push(t[A]),H();return q&&(w=ee(w)),E}function B(e,n){let t="";return t=Y(e.from)+Y(e.to),t}function K(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function z(e){let n,t,r,l=q[e],f=ee(e);for(n=0,t=g[u].length;n<t;++n)if(r=l+g[u][n],null!=v[r]&&!te(r)&&v[r].color===f&&v[r].type===u&&!ie(r,n<4?3-n:11-n))return!0;for(n=0,t=g[s].length;n<t;++n){let e=g[s][n],t=!1;for(r=l+e;!te(r);r+=e){let e=v[r];if(null!=e){if(e.color===f)if(t){if(e.type===o)return!0}else if(e.type===s||e.type===c)return!0;if(t)break;t=!0}}}for(n=0,t=d[f].length;n<t;++n)if(r=l-d[f][n],null!=v[r]&&!te(r)&&v[r].color===f&&v[r].type===i)return!0;return!1}function F(){return z(w)}function T(){return F()&&0===U().length}function S(){return!F()&&0===U().length}function M(){let e,n={},t=0;for(let r in y)y.hasOwnProperty(r)&&(e=v[y[r]],e&&(n[e.type]=e.type in n?n[e.type]+1:1,t++));return 2===t||void 0===n[u]&&void 0===n[s]&&void 0===n[o]&&void 0===n[i]}function X(){let e,n=[],t={},r=!1;for(;e=H(),e;)n.push(e);for(;;){let e=j().split(" ").slice(0,2).join(" ");if(t[e]=e in t?t[e]+1:1,t[e]>=3&&(r=!0),!n.length)break;Z(n.pop())}return r}function G(e,n){e.push({move:n,kings:{b:q.b,r:q.r},turn:w,half_moves:A,move_number:N})}function Z(e){G(k,e),null!=v[e.to]&&v[e.to].type===c&&(q[v[e.to].color]=r),v[e.to]=v[e.from],v[e.from]=null,v[e.to].type===c&&(q[v[e.to].color]=e.to),e.flags&m.CAPTURE?A=0:A++,w===n&&N++,w=ee(w)}function D(e,n=!0){if(null==e)return null;const t=e.move;return q=e.kings,w=e.turn,A=e.half_moves,N=e.move_number,v[t.from]=v[t.to],v[t.from].type=t.piece,v[t.to]=null,(t.flags&m.CAPTURE)>0&&n&&(v[t.to]={type:t.captured,color:ee(w)}),t}function H(){return D(k.pop())}function Q(){let e="   +---------------------------+\n";for(let n=y.a9;n<=y.i0;n++){if(0===J(n)&&(e+=" "+"9876543210"[W(n)]+" |"),null==v[n])e+=" . ";else{let r=v[n].type;e+=" "+(v[n].color===t?r.toUpperCase():r.toLowerCase())+" "}8&n&&(e+="|\n",n+=7)}return e+="   +---------------------------+\n",e+="     a  b  c  d  e  f  g  h  i\n",e}function V(e,n){let t,r,i,o=K(e),s=o.match(/([a-iA-I][0-9])-?([a-iA-I][0-9])/);n&&s&&(t=s[1],r=s[2],i=s[3]);let u=U();for(let e=0,l=u.length;e<l;e++){if(o===K(B(u[e]))||n&&o===K(B(u[e])))return u[e];if(s&&(!t||t.toLowerCase()===u[e].piece)&&y[r]===u[e].from&&y[i]===u[e].to)return u[e]}return null}function W(e){return e>>4}function J(e){return 15&e}function Y(e){const n=J(e),t=W(e);return"abcdefghi".substring(n,n+1)+"9876543210".substring(t,t+1)}function ee(e){return e===t?n:t}function ne(e,n){return n===t?W(e)<5:W(e)>4}function te(e){return e<0||W(e)>9||J(e)>8}function re(e,r,o){let s={};if(e===i)return s=[0,2,4,6,8],o===t?W(r)>6||W(r)>4&&-1===s.indexOf(J(r)):W(r)<3||W(r)<5&&-1===s.indexOf(J(r));if(e===l)s[t]=[146,150,112,116,120,82,86],s[n]=[2,6,32,36,40,66,70];else if(e===f)s[t]=[147,149,132,115,117],s[n]=[3,5,20,35,37];else{if(e!==c)return te(r);s[t]=[147,148,149,131,132,133,115,116,117],s[n]=[3,4,5,19,20,21,35,36,37]}return-1===s[o].indexOf(r)}function ie(e,n){return null!=v[e+[-16,16,-1,1][Math.floor(n/2)]]}function oe(e,n){return null!=v[e+[-17,17,15,-15][n]]}function se(e){let n=ue(e);n.iccs=B(n),n.to=Y(n.to),n.from=Y(n.from),n.piece=w===t?n.piece.toUpperCase():n.piece;let r="";for(let e in m)(m[e]&n.flags)>0&&(r+=b[e]);return n.flags=r,n}function ue(e){let n=e instanceof Array?[]:{};for(let t in e)n[t]="object"==typeof t?ue(e[t]):e[t];return n}function le(e){return e.replace(/^\s+|\s+$/g,"")}function fe(e){const n=U({legal:!1});let t=0;for(let r=0,i=n.length;r<i;r++){if(Z(n[r]),!z(w))if(e-1>0){t+=fe(e-1)}else t++;H()}return t}return P(void 0===e?p:e),{RED:t,BLACK:n,PAWN:i,CANNON:o,ROOK:s,KNIGHT:u,BISHOP:l,ADVISER:f,KING:c,SQUARES:function(){let e=[];for(let n=y.a9;n<=y.i0;n++)9!==J(n)?e.push(Y(n)):n+=6;return e}(),FLAGS:b,load:function(e){return P(e)},reset:function(){return C()},moves:function(e){const n=U(e);let t=[];for(let r=0,i=n.length;r<i;r++)void 0!==e&&"verbose"in e&&e.verbose?t.push(se(n[r])):t.push(B(n[r]));return t},in_check:function(){return F()},in_checkmate:function(){return T()},in_stalemate:function(){return S()},in_draw:function(){return A>=120||X()||M()},insufficient_material:function(){return M()},in_threefold_repetition:function(){return X()},game_over:function(){return A>=120||T()||S()||M()||X()||q[ee(w)]===r},validate_fen:function(e){return E(e)},fen:function(){return j()},board:function(){let e=[],n=[];for(let t=y.a9;t<=y.i0;t++)null==v[t]?n.push(null):n.push({type:v[t].type,color:v[t].color}),8&t&&(e.push(n),n=[],t+=7);return e},pgn:function(e){let n,t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",r="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,i=[],o=!1;for(n in _)i.push("["+n+' "'+_[n]+'"]'+t),o=!0;o&&k.length&&i.push(t);let s=[];for(;k.length>0;)s.push(H());let u=[],l="";for(;s.length>0;){let e=s.pop();k.length||"b"!==e.color?"b"!==e.color&&(l.length&&u.push(l),l=N+"."):l=N+". ...",l=l+" "+B(e),Z(e)}if(l.length&&u.push(l),void 0!==_.Result&&u.push(_.Result),0===r)return i.join("")+u.join(" ");let f=0;for(n=0;n<u.length;n++)f+u[n].length>r&&0!==n?(" "===i[i.length-1]&&i.pop(),i.push(t),f=0):0!==n&&(i.push(" "),f++),i.push(u[n]),f+=u[n].length;return i.join("")},load_pgn:function(e,n){let t=void 0!==n&&"sloppy"in n&&n.sloppy;function r(e){return e.replace(/\\/g,"\\")}const i="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",o=new RegExp("^(?:\\s)*(((?:"+r(i)+")*\\[[^\\]]+\\])+)"),s=o.test(e)?o.exec(e)[1]:"";C();const u=function(e,n){let t="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",i={},o=e.split(new RegExp(r(t))),s="",u="";for(let e=0;e<o.length;e++)s=o[e].replace(/^\[([A-Z][A-Za-z]*)\s.*]$/,"$1"),u=o[e].replace(/^\[[A-Za-z]+\s"(.*)"]$/,"$1"),le(s).length>0&&(i[s]=u);return i}(s,n);for(let e in u)u.hasOwnProperty(e)&&x([e,u[e]]);if("FEN"in u&&!P(u.FEN,!0))return console.warn("load header FEN failed!"),!1;let l=e.replace(s,"").replace(new RegExp(r(i),"g")," ");l=l.replace(/({[^}]+})+?/g,"");const f=/(\([^()]+\))+?/g;for(;f.test(l);)l=l.replace(f,"");l=l.replace(/\d+\.(\.\.)?/g,""),l=l.replace(/\.\.\./g,""),l=l.replace(/\$\d+/g,"");let c=le(l).split(new RegExp(/\s+/));c=c.join(",").replace(/,,+/g,",").split(",");let a="";for(let e=0;e<c.length-1;e++){if(a=V(c[e],t),null==a)return console.warn(`impossible move: ${c[e]}!\n${Q()}`),!1;Z(a)}if(a=c[c.length-1],h.indexOf(a)>-1)(function(e){for(let n in e)if(e.hasOwnProperty(n))return!0;return!1})(_)&&void 0===_.Result&&x(["Result",a]);else{if(a=V(a,t),null==a)return console.warn(`impossible last move: ${c[c.length-1]}!\n${Q()}`),!1;Z(a)}return!0},header:function(){return x(arguments)},ascii:function(){return Q()},turn:function(){return w},move:function(e,n){const t=void 0!==n&&"sloppy"in n&&n.sloppy;let r=null;if("string"==typeof e)r=V(e,t);else if("object"==typeof e){let n=U();for(let t=0,i=n.length;t<i;t++)if(e.from===Y(n[t].from)&&e.to===Y(n[t].to)&&!(""in n[t])){r=n[t];break}}if(!r)return null;const i=se(r);return Z(r),R=[],i},undo:function(){G(R,null);const e=H();if(e){const n=se(e);return[e.from,e.to]=[e.to,e.from],R[R.length-1].move=e,n}return R.pop(),null},redo:function(){G(k,null);const e=D(R.pop(),!1);return e?([e.from,e.to]=[e.to,e.from],k[k.length-1].move=e,se(e)):(k.pop(),null)},clear:function(){return O()},put:function(e,n){return L(e,n)},get:function(e){return I(e)},remove:function(e){return function(e){const n=I(e);return v[y[e]]=null,n&&n.type===c&&(q[n.color]=r),$(j()),n}(e)},perft:function(e){return fe(e)},history:function(e){let n=[],t=[],r=void 0!==e&&"verbose"in e&&e.verbose;for(;k.length>0;)n.push(H());for(;n.length>0;){let e=n.pop();r?t.push(se(e)):t.push(B(e)),Z(e)}return t}}};"undefined"!=typeof exports&&(exports.Xiangqi=Xiangqi),"undefined"!=typeof define&&define((function(){return Xiangqi}));